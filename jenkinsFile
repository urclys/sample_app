pipeline {
    agent any

    stages {
        stage('Build and Deploy') {
            steps {
                script {
                    // Define your array of folder names
                    def folderNames = ['folder1', 'folder2', 'folder3', 'folder4', 'folder5', 'folder6', 'folder7', 'folder8']

                    // This will hold our dynamic stages
                    def parallelStages = [:]

                    // Split the folder names into groups of 4
                    for (int i = 0; i < folderNames.size(); i += 4) {
                        def batch = folderNames[i..<Math.min(i+4, folderNames.size())]

                        for (int j = 0; j < batch.size(); j++) {
                            def folderName = batch[j]

                            // Create a stage for each folder and add it to the parallel stages
                            parallelStages["Process ${folderName}"] = {
                                stage("Process ${folderName}") {
                                    // Your actions here, using the folderName variable
                                    echo "Processing ${folderName}"
                                }
                            }
                        }

                        // Execute the stages in this batch in parallel
                        parallel parallelStages

                        // Clear the stages for the next batch
                        parallelStages.clear()
                    }
                }
            }
        }
    }
}
